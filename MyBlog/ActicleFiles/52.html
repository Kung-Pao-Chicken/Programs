<p>　　众所周知，Http协议是无状态的，并且是基于Request/Response的方式与服务器进行交互，也就是我们常说的单工模式。但是随着
互联网的发展，浏览器与服务端进行双向通信需求的增加，长轮询向服务器以获取最新数据并实现推送效果的方式已经越来越不能满足我们。Html5标准的制
定，也为我们提供了浏览器与服务端的双工通信协议WebSocket。</p><p>　　WebSocket协议的格式为 &quot;ws://IP:Port&quot; 或者“wss://IP:Port&quot;。其中wss表示进行加密传输的websocket协议。</p><p>　　WebSocket协议与传统的Socket协议一样，都需要进行“握手”。但是WebSocket的“握手”阶段是通过Http协议进行的，
“握手”行为通过Request/Response的Header完成，只需要交换很少的数据，便可以创建基于TCP/IP协议的双工通道。下面我们来看
一下Fiddler截取到的WebSocket握手请求</p><p>　　<img src="http://images.cnitblog.com/i/340851/201405/061628329176659.jpg" alt="" height="550" width="1040"/></p><p>　　通过Fiddler我们可以看到，在握手请求时，客户端向服务端发送了一个Get请求，并且在请求的头中增加了这么几个Key</p><p>　　Origin:http://IP:Port 表示客户端的地址</p><p>　　Connection:Upgrade /&nbsp;Upgrade:WebSocket 表示本次请求是要进行WebSocket的握手动作</p><p>　　Sec-WebSocket-Version: 13 表示浏览器支持的WebSocket版本信息</p><p>　　</p><p>　　Sec-WebSocket-Key:&nbsp;&nbsp;&nbsp;&nbsp; 这是一个由客户端随机生成的字符串</p><p>　　</p><p>　　在服务器响应的握手信息中Sec-WebSocket-Accept:的值为服务器通过客户端Header的Sec-WebSocket-Key的值进行计算并加密的结果。</p><p>　　</p><p>　　并且服务器的响应状态为101&nbsp; 表示服务器端已经理解了客户端的需求，并且客户端需要根据Upgrade中的协议类型，切换为新的协议来完成后续的通信。</p><p>&nbsp;</p><p>　　这时候我们的TCP/IP双工通道就已经建立了，WebSocket协议就这么简单。</p><p>&nbsp;</p><p>　　说完理论知识了，我们来看如何在浏览器中使用WebSocket协议。</p><p>　　</p><p>　　</p><p>　　最新的FireFox、Chrome、IE10及以上版本都已经支持了WebSocket协议。但是在使用它时，我们需要先检测浏览器是否支持WebSocket协议</p><p>　　WebSocket对象位于 window对象下。我们可以通过以下代码检测浏览器对WebSocket的支持</p><p>　　</p><p>　　</p><div class="cnblogs_code"><img id="code_img_opened_5e6ba4bc-5c33-4bd6-afd3-4af042865f42" class="code_img_opened" style="" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""/><div style="display: block;" id="cnblogs_code_open_5e6ba4bc-5c33-4bd6-afd3-4af042865f42" class="cnblogs_code_hide"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a title="复制代码" href="http://"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"/></a></span></div><pre><span style="color: #0000ff;">if</span>(&quot;WebSocket&quot; <span style="color: #0000ff;">in</span><span style="color: #000000;"> window)</span><span style="color: #0000ff;">if</span><span style="color: #000000;">(window.WebSocket)</span><span style="color: #0000ff;">if</span>(&quot;MozWebSocket&quot; <span style="color: #0000ff;">in</span><span style="color: #000000;"> window)</span><span style="color: #0000ff;">if</span>(window.MozWebSocket)</pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a title="复制代码" href="http://"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"/></a></span></div></div></div><p>　　</p><p>　　如果我们的浏览器支持WebSocket 那么我们就可以创建WebSocket的实例了。</p><p>　　</p><div class="cnblogs_code"><img id="code_img_opened_46ce7d98-facc-4082-b339-4c4219a89964" class="code_img_opened" style="" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""/><div style="display: block;" id="cnblogs_code_open_46ce7d98-facc-4082-b339-4c4219a89964" class="cnblogs_code_hide"><pre><span style="color: #0000ff;">var</span> ws=<span style="color: #0000ff;">new</span> WebSocket(&quot;ws://localhost:2012&quot;<span style="color: #000000;">);</span><span style="color: #0000ff;">var</span> ws=<span style="color: #0000ff;">new</span> MozWebSocket(&quot;ws://localhost:2012);</pre></div></div><p>　　</p><p>　　</p><p>　　这里需要注意一下，当我们创建WebSocket的实例时，这个WebSocket实例就已经开始向服务器发起握手请求了，不需要我们手动打开连接。</p><p>　　WebSocket对象也很简单，我们会常用到它的4个回调方法 onopen onclose onerror onmessage。他们触发的实际分别为 握手完成并创建TCP/IP通道后，断开连接后，发生错误时，接收到服务端消息时。</p><p>　　另外我们还常常用到一个属性 readyState 用以检查连接状态，和一个函数 send() 向服务端发送数据。</p><p>　　</p><p>　　下面我们来完成一个完整的浏览器使用WebSocket的例子，这里需要服务端也支持WebSocket协议</p><p>　　</p><p>　　</p><p>　　</p><img id="code_img_opened_b996337c-b73c-4b3f-bdf4-4723a4260456" class="code_img_opened" style="" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""/><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a title="复制代码" href="http://"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"/></a></span></div><pre><span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE html</span><span style="color: #0000ff;">&gt;</span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">html </span><span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">=&quot;http://www.w3.org/1999/xhtml&quot;</span><span style="color: #0000ff;">&gt;</span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">meta </span><span style="color: #ff0000;">http-equiv</span><span style="color: #0000ff;">=&quot;Content-Type&quot;</span><span style="color: #ff0000;"> content</span><span style="color: #0000ff;">=&quot;text/html; charset=utf-8&quot;</span> <span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>WebSocket示例<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">script </span><span style="color: #ff0000;">type</span><span style="color: #0000ff;">=&quot;text/javascript&quot;</span><span style="color: #0000ff;">&gt;</span>
        <span style="background-color: #f5f5f5; color: #0000ff;">var</span><span style="background-color: #f5f5f5; color: #000000;"> ws;</span><span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">WebSocket对象</span>
        <span style="background-color: #f5f5f5; color: #0000ff;">var</span><span style="background-color: #f5f5f5; color: #000000;"> wsUrl </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">ws://localhost:2012</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">;</span><span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">支持WebSocket协议的服务器端地址</span>

        <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;"> connection() { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">判断该使用哪种WebSocket对象 </span>
            <span style="background-color: #f5f5f5; color: #0000ff;">if</span><span style="background-color: #f5f5f5; color: #000000;"> (</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">WebSocket</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span> <span style="background-color: #f5f5f5; color: #0000ff;">in</span><span style="background-color: #f5f5f5; color: #000000;"> window) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ws </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">new</span><span style="background-color: #f5f5f5; color: #000000;"> WebSocket(wsUrl);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff;">else</span> <span style="background-color: #f5f5f5; color: #0000ff;">if</span><span style="background-color: #f5f5f5; color: #000000;"> (</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">MozWebSocket</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span> <span style="background-color: #f5f5f5; color: #0000ff;">in</span><span style="background-color: #f5f5f5; color: #000000;"> window) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ws </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">new</span><span style="background-color: #f5f5f5; color: #000000;"> MozWebSocket(wsUrl);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;} </span><span style="background-color: #f5f5f5; color: #0000ff;">else</span><span style="background-color: #f5f5f5; color: #000000;"> {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;alert(</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">当前浏览器不支持WebSocket</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">);

 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">注册各类回调</span><span style="background-color: #f5f5f5; color: #000000;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ws.onopen </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;"> () {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;alert(</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">连接服务器成功</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}

 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ws.onclose </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;"> () {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;alert(</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">与服务器断开连接</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ws.onerror </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;"> () {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;alert(</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">数据传输发生错误</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ws.onmessage </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;"> (receiveMsg) {
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;alert(receiveMsg.data);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}
 &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;"> sendMessage() { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">尝试向服务端发送消息</span><span style="background-color: #f5f5f5; color: #000000;">
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ws.send(</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">Hello World</span><span style="background-color: #f5f5f5; color: #000000;">&quot;</span><span style="background-color: #f5f5f5; color: #000000;">);

 &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;</span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">script</span><span style="color: #0000ff;">&gt;</span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">input </span><span style="color: #ff0000;">type</span><span style="color: #0000ff;">=&quot;button&quot;</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">=&quot;Connection&quot;</span><span style="color: #ff0000;"> onclick</span><span style="color: #0000ff;">=&quot;connection()&quot;</span> <span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">input </span><span style="color: #ff0000;">type</span><span style="color: #0000ff;">=&quot;button&quot;</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">=&quot;Send&quot;</span><span style="color: #ff0000;"> onclick</span><span style="color: #0000ff;">=&quot;sendMessage()&quot;</span> <span style="color: #0000ff;">/&gt;</span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">html</span><span style="color: #0000ff;">&gt;</span></pre>